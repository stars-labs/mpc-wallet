<!DOCTYPE html>
<html>
<head>
    <title>Extension Load Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            max-width: 800px; 
            margin: 0 auto;
        }
        .status { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 5px; 
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            font-family: monospace;
        }
        button {
            margin: 5px;
            padding: 10px 15px;
            background: #6366F1;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover { background: #5558F0; }
    </style>
</head>
<body>
    <h1>MPC Wallet Extension Test</h1>
    
    <div id="status" class="status info">Checking extension...</div>
    
    <div>
        <button onclick="checkProviders()">Check Providers</button>
        <button onclick="testConnection()">Test Connection</button>
        <button onclick="testRPCMethods()">Test RPC Methods</button>
    </div>
    
    <div id="results"></div>
    
    <script>
        const status = document.getElementById('status');
        const results = document.getElementById('results');
        
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = 'test-result';
            div.textContent = message;
            results.appendChild(div);
            console.log(message);
        }
        
        function updateStatus(message, type = 'info') {
            status.textContent = message;
            status.className = `status ${type}`;
        }
        
        // Check providers on load
        window.addEventListener('load', () => {
            setTimeout(() => {
                checkProviders();
            }, 500);
        });
        
        function checkProviders() {
            results.innerHTML = '';
            log('=== Checking Providers ===');
            
            // Check window.ethereum
            if (window.ethereum) {
                log('✅ window.ethereum found');
                log(`  - isStarLabWallet: ${window.ethereum.isStarLabWallet}`);
                log(`  - chainId: ${window.ethereum.chainId}`);
                log(`  - networkVersion: ${window.ethereum.networkVersion}`);
                
                if (window.ethereum.providers) {
                    log(`  - Multiple providers: ${window.ethereum.providers.length}`);
                }
            } else {
                log('❌ window.ethereum not found');
            }
            
            // Check window.starlabEthereum
            if (window.starlabEthereum) {
                log('✅ window.starlabEthereum found');
            } else {
                log('❌ window.starlabEthereum not found');
            }
            
            // Request EIP-6963 providers
            log('\n=== EIP-6963 Provider Discovery ===');
            const providers = new Map();
            
            const listener = (event) => {
                const detail = event.detail;
                providers.set(detail.info.uuid, detail);
                log(`Provider announced: ${detail.info.name}`);
                log(`  - UUID: ${detail.info.uuid}`);
                log(`  - RDNS: ${detail.info.rdns}`);
                
                if (detail.info.name === 'MPC Wallet') {
                    updateStatus('✅ MPC Wallet detected via EIP-6963', 'success');
                }
            };
            
            window.addEventListener('eip6963:announceProvider', listener);
            window.dispatchEvent(new Event('eip6963:requestProvider'));
            
            setTimeout(() => {
                window.removeEventListener('eip6963:announceProvider', listener);
                log(`\nTotal providers discovered: ${providers.size}`);
                
                if (providers.size === 0 && !window.ethereum) {
                    updateStatus('❌ No providers found. Is the extension loaded?', 'error');
                }
            }, 1000);
        }
        
        async function testConnection() {
            results.innerHTML = '';
            log('=== Testing Connection ===');
            
            if (!window.ethereum) {
                log('❌ No ethereum provider available');
                return;
            }
            
            try {
                log('Requesting accounts...');
                const accounts = await window.ethereum.request({ 
                    method: 'eth_requestAccounts' 
                });
                log(`✅ Connected! Accounts: ${JSON.stringify(accounts)}`);
                updateStatus('✅ Successfully connected', 'success');
            } catch (error) {
                log(`❌ Connection error: ${error.message}`);
                updateStatus('❌ Connection failed', 'error');
            }
        }
        
        async function testRPCMethods() {
            results.innerHTML = '';
            log('=== Testing RPC Methods ===');
            
            if (!window.ethereum) {
                log('❌ No ethereum provider available');
                return;
            }
            
            const methods = [
                'eth_chainId',
                'eth_accounts',
                'net_version'
            ];
            
            for (const method of methods) {
                try {
                    const result = await window.ethereum.request({ method });
                    log(`✅ ${method}: ${JSON.stringify(result)}`);
                } catch (error) {
                    log(`❌ ${method}: ${error.message}`);
                }
            }
            
            updateStatus('✅ RPC tests completed', 'success');
        }
    </script>
    
    <hr style="margin-top: 40px;">
    <p><strong>Instructions:</strong></p>
    <ol>
        <li>Make sure the MPC Wallet extension is loaded in your browser</li>
        <li>Navigate to chrome://extensions and load the unpacked extension from <code>.output/chrome-mv3/</code></li>
        <li>Refresh this page after loading the extension</li>
        <li>Click the buttons above to test different aspects of the EIP-6963 implementation</li>
    </ol>
</body>
</html>