import { Button, StandardButton, LineEdit, TextEdit, VerticalBox, HorizontalBox, ScrollView, GridBox } from "std-widgets.slint";
import { Theme, Card, StatusBadge, PrimaryButton } from "style.slint";

export global AppState {
    in-out property <bool> websocket-connected: false;
    in-out property <string> device-id: "";
    in-out property <string> session-status: "No active session";
    in-out property <string> generated-address: "";
    in-out property <[string]> log-messages: [];
}

component LogEntry inherits Rectangle {
    in property <string> message;
    in property <int> index;
    
    background: Math.mod(index, 2) == 0 ? Theme.bg-tertiary : transparent;
    border-radius: Theme.radius-sm;
    height: self.preferred-height;
    min-height: 40px;
    
    animate background {
        duration: 200ms;
        easing: ease-in-out;
    }
    
    states [
        hover when touch.has-hover : {
            background: Theme.bg-hover;
        }
    ]
    
    touch := TouchArea {
        HorizontalBox {
            padding: Theme.spacing-md;
            spacing: Theme.spacing-sm;
            
            Text {
                text: (index + 1) + ".";
                font-size: Theme.font-xs;
                color: Theme.text-muted;
                width: 30px;
                horizontal-alignment: right;
            }
            
            Text {
                text: root.message;
                font-size: Theme.font-sm;
                font-family: "monospace";
                color: Theme.text-primary;
                wrap: word-wrap;
                overflow: elide;
            }
        }
    }
}

export component MainWindow inherits Window {
    title: "MPC Wallet - Native Node";
    preferred-width: 1200px;
    preferred-height: 800px;
    min-width: 900px;
    min-height: 600px;
    
    callback connect-websocket(string);
    callback start-dkg();
    
    background: Theme.bg-primary;
    
    VerticalBox {
        padding: Theme.spacing-lg;
        spacing: Theme.spacing-lg;
        
        // Header
        Rectangle {
            height: 90px;
            background: Theme.bg-secondary;
            border-radius: Theme.radius-lg;
            drop-shadow-blur: 20px;
            drop-shadow-color: Theme.shadow-color;
            
            HorizontalBox {
                padding: Theme.spacing-lg;
                alignment: space-between;
                
                VerticalBox {
                    alignment: center;
                    spacing: Theme.spacing-xs;
                    
                    HorizontalBox {
                        spacing: Theme.spacing-md;
                        alignment: center;
                        
                        // Logo/Icon placeholder
                        Rectangle {
                            width: 48px;
                            height: 48px;
                            background: Theme.accent-primary;
                            border-radius: Theme.radius-md;
                            
                            Text {
                                text: "üîê";
                                font-size: 24px;
                                horizontal-alignment: center;
                                vertical-alignment: center;
                            }
                        }
                        
                        VerticalBox {
                            spacing: 2px;
                            
                            Text {
                                text: "MPC Wallet Node";
                                font-size: Theme.font-2xl;
                                font-weight: 700;
                                color: Theme.text-primary;
                            }
                            
                            Text {
                                text: "Secure Multi-Party Computation Protocol";
                                font-size: Theme.font-md;
                                color: Theme.text-secondary;
                            }
                        }
                    }
                }
                
                StatusBadge {
                    connected: AppState.websocket-connected;
                }
            }
        }
        
        // Main Content Area
        HorizontalBox {
            spacing: Theme.spacing-lg;
            
            // Left Panel - Controls
            VerticalBox {
                width: 420px;
                spacing: Theme.spacing-lg;
                
                // Connection Card
                Card {
                    title: "Device Connection";
                    
                    VerticalBox {
                        spacing: Theme.spacing-md;
                        
                        VerticalBox {
                            spacing: Theme.spacing-sm;
                            
                            Text {
                                text: "Device Identifier";
                                font-size: Theme.font-sm;
                                color: Theme.text-secondary;
                                font-weight: 500;
                            }
                            
                            Rectangle {
                                height: 48px;
                                background: Theme.bg-tertiary;
                                border-radius: Theme.radius-md;
                                border-width: 1px;
                                border-color: Theme.border-color;
                                
                                LineEdit {
                                    width: 100%;
                                    height: 100%;
                                    placeholder-text: "Enter your unique device ID";
                                    text <=> AppState.device-id;
                                    font-size: Theme.font-md;
                                    padding: Theme.spacing-md;
                                    background: transparent;
                                    
                                    // Custom styling for LineEdit
                                }
                            }
                        }
                        
                        PrimaryButton {
                            text: AppState.websocket-connected ? "Reconnect" : "Connect to Network";
                            width: 100%;
                            clicked => { connect-websocket(AppState.device-id); }
                        }
                        
                        if AppState.websocket-connected : Rectangle {
                            background: rgba(74, 222, 128, 0.1);
                            border-radius: Theme.radius-md;
                            padding: Theme.spacing-md;
                            
                            HorizontalBox {
                                spacing: Theme.spacing-sm;
                                
                                Text {
                                    text: "‚úì";
                                    color: Theme.accent-success;
                                    font-size: Theme.font-md;
                                }
                                
                                Text {
                                    text: "Successfully connected to signaling server";
                                    color: Theme.accent-success;
                                    font-size: Theme.font-sm;
                                }
                            }
                        }
                    }
                }
                
                // Key Generation Card
                Card {
                    title: "Distributed Key Generation";
                    
                    VerticalBox {
                        spacing: Theme.spacing-md;
                        
                        Rectangle {
                            background: Theme.bg-tertiary;
                            border-radius: Theme.radius-md;
                            padding: Theme.spacing-md;
                            
                            VerticalBox {
                                spacing: Theme.spacing-xs;
                                
                                Text {
                                    text: "Session Status";
                                    font-size: Theme.font-xs;
                                    color: Theme.text-muted;
                                    font-weight: 500;
                                }
                                
                                Text {
                                    text: AppState.session-status;
                                    font-size: Theme.font-md;
                                    color: Theme.text-primary;
                                    wrap: word-wrap;
                                }
                            }
                        }
                        
                        PrimaryButton {
                            text: "Initialize DKG Protocol";
                            width: 100%;
                            enabled: AppState.websocket-connected;
                            clicked => { start-dkg(); }
                        }
                        
                        if !AppState.websocket-connected : Text {
                            text: "Connect to network first to start DKG";
                            font-size: Theme.font-xs;
                            color: Theme.text-muted;
                            horizontal-alignment: center;
                        }
                    }
                }
                
                // Generated Address Display
                if AppState.generated-address != "" : Card {
                    title: "Generated Wallet Address";
                    
                    Rectangle {
                        background: Theme.bg-tertiary;
                        border-radius: Theme.radius-md;
                        padding: Theme.spacing-md;
                        border-width: 1px;
                        border-color: Theme.accent-success;
                        
                        VerticalBox {
                            spacing: Theme.spacing-sm;
                            
                            Text {
                                text: "üéâ Successfully Generated";
                                font-size: Theme.font-sm;
                                color: Theme.accent-success;
                                font-weight: 500;
                            }
                            
                            Text {
                                text: AppState.generated-address;
                                font-size: Theme.font-md;
                                font-family: "monospace";
                                color: Theme.text-primary;
                                wrap: word-wrap;
                                selection-mode: text;
                            }
                        }
                    }
                }
            }
            
            // Right Panel - Activity Logs
            Card {
                title: "Activity Logs";
                
                VerticalBox {
                    spacing: Theme.spacing-md;
                    
                    // Log stats
                    HorizontalBox {
                        spacing: Theme.spacing-lg;
                        
                        Rectangle {
                            background: Theme.bg-tertiary;
                            border-radius: Theme.radius-md;
                            padding-left: Theme.spacing-md;
                            padding-right: Theme.spacing-md;
                            padding-top: Theme.spacing-sm;
                            padding-bottom: Theme.spacing-sm;
                            
                            HorizontalBox {
                                spacing: Theme.spacing-sm;
                                
                                Text {
                                    text: "üìù";
                                    font-size: Theme.font-md;
                                }
                                
                                Text {
                                    text: AppState.log-messages.length + " entries";
                                    font-size: Theme.font-sm;
                                    color: Theme.text-secondary;
                                }
                            }
                        }
                        
                        Rectangle {
                            background: AppState.websocket-connected ? rgba(74, 222, 128, 0.1) : Theme.bg-tertiary;
                            border-radius: Theme.radius-md;
                            padding-left: Theme.spacing-md;
                            padding-right: Theme.spacing-md;
                            padding-top: Theme.spacing-sm;
                            padding-bottom: Theme.spacing-sm;
                            
                            HorizontalBox {
                                spacing: Theme.spacing-sm;
                                
                                Text {
                                    text: AppState.websocket-connected ? "üü¢" : "üî¥";
                                    font-size: Theme.font-md;
                                }
                                
                                Text {
                                    text: AppState.websocket-connected ? "Live" : "Offline";
                                    font-size: Theme.font-sm;
                                    color: AppState.websocket-connected ? Theme.accent-success : Theme.text-secondary;
                                }
                            }
                        }
                    }
                    
                    // Log container
                    Rectangle {
                        background: Theme.bg-primary;
                        border-radius: Theme.radius-md;
                        border-width: 1px;
                        border-color: Theme.border-color;
                        min-height: 400px;
                        
                        ScrollView {
                            padding: Theme.spacing-xs;
                            
                            VerticalBox {
                                if AppState.log-messages.length == 0 : Rectangle {
                                    height: 400px;
                                    
                                    VerticalBox {
                                        alignment: center;
                                        spacing: Theme.spacing-md;
                                        
                                        Text {
                                            text: "üìã";
                                            font-size: 48px;
                                            horizontal-alignment: center;
                                            opacity: 0.3;
                                        }
                                        
                                        Text {
                                            text: "No activity logs yet";
                                            font-size: Theme.font-lg;
                                            color: Theme.text-muted;
                                            horizontal-alignment: center;
                                        }
                                        
                                        Text {
                                            text: "Logs will appear here when you connect";
                                            font-size: Theme.font-sm;
                                            color: Theme.text-muted;
                                            horizontal-alignment: center;
                                        }
                                    }
                                }
                                
                                for log[index] in AppState.log-messages : LogEntry {
                                    message: log;
                                    index: index;
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}