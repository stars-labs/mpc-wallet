import { VerticalBox, HorizontalBox, ProgressIndicator } from "std-widgets.slint";

export struct Participant {
    id: string,
    name: string,
    status: string, // "ready", "processing", "completed", "failed", "offline"
    round_completed: int,
}

export component DkgProgress inherits Rectangle {
    in property <bool> active: false;
    in property <int> current_round: 0;
    in property <int> total_rounds: 3;
    in property <float> progress: 0.0;
    in property <[Participant]> participants: [];
    in property <string> threshold: "2/3";
    in property <string> session_id: "";
    
    callback abort_dkg();
    
    preferred-height: active ? 280px : 0px;
    visible: active;
    background: #16213E;
    border-radius: 8px;
    animate preferred-height { duration: 300ms; easing: ease-in-out; }
    
    VerticalBox {
        padding: 16px;
        spacing: 16px;
        
        // Header
        HorizontalBox {
            Text {
                text: "DKG in Progress";
                color: white;
                font-size: 16px;
                font-weight: 600;
            }
            
            Rectangle { } // Spacer
            
            Text {
                text: "Session: " + session_id;
                color: #64748B;
                font-size: 12px;
                vertical-alignment: center;
            }
            
            Rectangle {
                width: 1px;
                height: 16px;
                background: #334155;
                margin-left: 12px;
                margin-right: 12px;
            }
            
            Text {
                text: "Threshold: " + threshold;
                color: #64748B;
                font-size: 12px;
                vertical-alignment: center;
            }
        }
        
        // Progress bar
        VerticalBox {
            spacing: 8px;
            
            HorizontalBox {
                Text {
                    text: "Round " + current_round + " of " + total_rounds;
                    color: #94A3B8;
                    font-size: 13px;
                }
                
                Rectangle { } // Spacer
                
                Text {
                    text: Math.round(progress * 100) + "%";
                    color: #10B981;
                    font-size: 13px;
                    font-weight: 500;
                }
            }
            
            Rectangle {
                height: 8px;
                border-radius: 4px;
                background: #0F172A;
                
                Rectangle {
                    width: parent.width * progress;
                    height: parent.height;
                    border-radius: parent.border-radius;
                    background: linear-gradient(90deg, #10B981, #059669);
                    
                    animate width { duration: 500ms; easing: ease-in-out; }
                }
            }
        }
        
        // Round indicators
        HorizontalBox {
            spacing: 8px;
            
            for round_num in [1, 2, 3]: Rectangle {
                width: 100px;
                height: 32px;
                border-radius: 6px;
                background: current_round > round_num ? #10B981 :
                           current_round == round_num ? #3B82F6 : #1E293B;
                
                Text {
                    text: round_num == 1 ? "Commitments" :
                          round_num == 2 ? "Shares" : "Finalize";
                    color: current_round >= round_num ? white : #64748B;
                    font-size: 12px;
                    font-weight: current_round == round_num ? 600 : 400;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                }
            }
        }
        
        // Participants
        VerticalBox {
            spacing: 8px;
            
            Text {
                text: "Participants";
                color: #94A3B8;
                font-size: 13px;
                font-weight: 500;
            }
            
            HorizontalBox {
                spacing: 12px;
                
                for participant in participants: Rectangle {
                    width: 120px;
                    height: 48px;
                    border-radius: 6px;
                    background: #0F172A;
                    border-width: 1px;
                    border-color: participant.status == "completed" ? #10B981 :
                                 participant.status == "processing" ? #3B82F6 :
                                 participant.status == "failed" ? #EF4444 :
                                 participant.status == "offline" ? #F59E0B : #334155;
                    
                    VerticalBox {
                        padding: 8px;
                        spacing: 4px;
                        
                        HorizontalBox {
                            spacing: 4px;
                            
                            // Status indicator
                            Rectangle {
                                width: 6px;
                                height: 6px;
                                border-radius: 3px;
                                background: participant.status == "completed" ? #10B981 :
                                           participant.status == "processing" ? #3B82F6 :
                                           participant.status == "failed" ? #EF4444 :
                                           participant.status == "offline" ? #F59E0B : #64748B;
                                vertical-alignment: center;
                            }
                            
                            Text {
                                text: participant.name;
                                color: white;
                                font-size: 12px;
                                font-weight: 500;
                            }
                        }
                        
                        Text {
                            text: participant.status == "processing" ? "Round " + participant.round_completed :
                                  participant.status;
                            color: #64748B;
                            font-size: 11px;
                        }
                    }
                }
            }
        }
        
        // Abort button
        HorizontalBox {
            Rectangle { } // Spacer
            
            TouchArea {
                width: 80px;
                height: 28px;
                
                Rectangle {
                    border-radius: 6px;
                    background: parent.pressed ? #DC2626 : 
                               parent.has-hover ? #B91C1C : #991B1B;
                    
                    Text {
                        text: "Abort";
                        color: white;
                        font-size: 12px;
                        font-weight: 500;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }
                }
                
                clicked => { abort_dkg(); }
            }
        }
    }
}