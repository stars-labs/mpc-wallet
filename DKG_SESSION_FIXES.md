# DKG Session ID and Participants List Fixes

## Issues Fixed

### 1. Session ID Display Mismatch
**Problem**: Different session IDs were displayed on each MPC node's DKG Progress screen. The UI was showing internal session IDs like "mpc-1-1758168398775" instead of the real DKG session ID "dkg_3dd6e323-d167-4fc2-98ee-72fcfd5213c9".

**Root Cause**: The `update.rs` was generating an internal session ID using `format!("{}-{}", model.device_id, chrono::Utc::now().timestamp_millis())` when handling the `CreateWallet` message, before the `StartDKG` command could generate the real DKG session ID.

**Fix**: 
- Modified `update.rs` to use a placeholder session ID ("pending") instead of generating an internal ID
- The real DKG session ID is generated by the `StartDKG` command
- Added `UpdateDKGSessionId` message to propagate the real session ID back to the model
- The UI now displays the correct DKG session ID on all nodes

### 2. Participants List Not Updating
**Problem**: The participants list on the DKG Progress screen only showed "mpc-1" even when all three nodes were connected.

**Root Cause**: The WebSocket handler was tracking participants locally in `participants_seen` but not updating the model's `active_session.participants` list.

**Fix**:
- Added new `UpdateParticipants` message type to update the participants list in the model
- Modified WebSocket handlers in both `StartDKG` and `JoinDKG` commands to send `UpdateParticipants` message when devices are received
- Updated `update.rs` to handle the `UpdateParticipants` message and update the model's active session
- The UI now correctly shows all connected participants

### 3. WebRTC Mesh Creation Issue
**Problem**: P2P WebRTC connections were not being established between participants.

**Root Cause**: The signal server was storing the wrong session ID (internal ID) which prevented proper participant tracking and WebRTC initiation.

**Fix**: With the session ID fix above, the signal server now properly tracks participants with the correct DKG session ID, allowing WebRTC connections to be initiated.

## Files Modified

1. **`apps/tui-node/src/elm/update.rs`**
   - Changed `CreateWallet` handler to use placeholder session ID instead of generating internal ID
   - Added handler for `UpdateParticipants` message

2. **`apps/tui-node/src/elm/message.rs`**
   - Added `UpdateParticipants { participants: Vec<String> }` message type

3. **`apps/tui-node/src/elm/command.rs`**
   - Modified `StartDKG` WebSocket handler to send `UpdateParticipants` message
   - Modified `JoinDKG` WebSocket handler to send `UpdateParticipants` message
   - Both handlers now properly update the participants list when devices are received

## Testing

Created `test-dkg-session.sh` script to verify the fixes:
- Starts 3 MPC nodes in headless mode
- Checks that all nodes display the same DKG session ID
- Verifies that participants lists are updated correctly
- Confirms WebRTC connections are initiated

## Result

After these fixes:
1. All nodes display the same DKG session ID (e.g., "dkg_3dd6e323-d167-4fc2-98ee-72fcfd5213c9")
2. Participants list correctly shows all connected nodes (e.g., ["mpc-1", "mpc-2", "mpc-3"])
3. WebRTC P2P mesh is properly created between all participants
4. DKG protocol can proceed with proper participant coordination