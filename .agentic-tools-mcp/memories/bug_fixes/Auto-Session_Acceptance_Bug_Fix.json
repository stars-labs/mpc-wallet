{
  "id": "a3bb6f70-d979-4951-941c-12a8bec2e787",
  "title": "Auto-Session Acceptance Bug Fix",
  "details": "**CRITICAL BUG FIX: Session Auto-Acceptance Issue**\n\n## **Problem Description:**\nThe MPC wallet was automatically accepting session invitations without user interaction. Users reported that `mpc-3` device was sending automatic `SessionResponse` with `accepted: true` immediately after receiving session proposals, bypassing the UI consent mechanism.\n\n## **Root Cause Analysis:**\nThe issue was in `/src/entrypoints/background/sessionManager.ts` in the `handleSessionProposal()` method, specifically lines 185-200. The problematic code was:\n\n```typescript\n// If this peer is the proposer, automatically accept and set up WebRTC\nif (fromPeerId === this.appState.deviceId) {\n    console.log(\"[SessionManager] ðŸŽ¯ This peer is the proposer, auto-accepting and setting up WebRTC\");\n    // ... auto-acceptance logic\n}\n```\n\n**The Problem:**\n- This auto-acceptance logic was designed for legitimate proposer auto-acceptance\n- However, `handleSessionProposal()` was being used for BOTH:\n  1. Legitimate proposer auto-acceptance (when `proposeSession()` calls it)\n  2. Processing incoming invitations from other peers (via WebSocket relay)\n- If there was any confusion in device IDs or message routing, this could trigger auto-acceptance for non-proposers\n\n## **Solution Implemented:**\n\n### 1. **Separated Auto-Acceptance Logic**\n- Created new method `handleProposerAutoAcceptance()` specifically for proposer auto-acceptance\n- Removed auto-acceptance logic from `handleSessionProposal()` \n- Now `handleSessionProposal()` ONLY handles invitations from other peers\n\n### 2. **Added Safety Check**\n- Added safety check in `handleSessionProposal()` to prevent `fromPeerId === this.appState.deviceId`\n- This prevents the bug from occurring even if there are routing issues\n\n### 3. **Updated Proposer Flow**\n- Modified `proposeSession()` to call `handleProposerAutoAcceptance()` instead of `handleSessionProposal()`\n\n## **Files Modified:**\n- `/src/entrypoints/background/sessionManager.ts`\n  - Added `handleProposerAutoAcceptance()` method\n  - Added safety check in `handleSessionProposal()`\n  - Updated `proposeSession()` to use correct method\n  - Removed problematic auto-acceptance logic\n\n## **Testing:**\n- Session proposals should now require explicit user acceptance for all non-proposer participants\n- Only the actual proposer should auto-accept their own sessions\n- UI should display invitations properly for manual user approval\n\n## **Impact:**\n- **SECURITY**: Prevents unauthorized automatic session acceptance\n- **UX**: Ensures users maintain control over session participation\n- **RELIABILITY**: Eliminates race conditions in session acceptance logic\n\nThis fix resolves the critical auto-acceptance vulnerability while maintaining proper proposer auto-acceptance functionality.",
  "category": "bug_fixes",
  "dateCreated": "2025-06-15T07:13:24.224Z",
  "dateUpdated": "2025-06-15T07:13:24.224Z"
}