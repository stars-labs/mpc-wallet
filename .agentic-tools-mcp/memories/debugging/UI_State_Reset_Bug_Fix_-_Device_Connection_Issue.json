{
  "id": "650f83cb-107d-406c-a592-c81fb0a5eafc",
  "title": "UI State Reset Bug Fix - Device Connection Issue",
  "details": "## UI State Disappears When New Device Connects - FIXED ✅\n\n### Problem Description\nUser reported that when a new device connects to the MPC wallet, the UI state disappears. After reopening the popup, the state shows back. This indicated a state management bug where UI state was being reset inappropriately.\n\n### Root Cause Analysis\nThe issue was in the **WebSocketManager** which was incorrectly broadcasting full `\"initialState\"` messages for incremental updates:\n\n1. **Device Connection Flow**:\n   - WebSocket receives \"devices\" message from server\n   - WebSocketManager.handleDeviceListMessage() processes the update\n   - StateManager.updateConnectedDevices() correctly broadcasts \"deviceList\" message\n   - **❌ PROBLEM**: WebSocketManager also broadcasts redundant \"initialState\" message\n\n2. **UI State Reset Logic**:\n   - When popup receives \"initialState\" message, it triggers onInitialState() callback\n   - This callback treats it as a \"fresh startup\" and resets UI state to localStorage defaults\n   - Any transient UI state (form inputs, settings panel state, etc.) gets lost\n\n3. **Multiple Problematic Locations**:\n   - handleDeviceListMessage() - broadcast both \"deviceList\" AND \"initialState\"\n   - setupEventHandlers() - broadcast \"initialState\" for WebSocket open/close/error events\n   - initialize() error handling - broadcast \"initialState\" on connection failures\n\n### Solution Implemented\n**Removed redundant \"initialState\" broadcasts** from WebSocketManager:\n\n1. **Device List Updates**: Removed redundant \"initialState\" broadcast, kept only the StateManager's \"deviceList\" broadcast\n2. **WebSocket Connection Events**: Removed \"initialState\" broadcasts from open/close/error handlers\n3. **Initialization Errors**: Removed \"initialState\" broadcast from error handling\n\n**Key Changes in webSocketManager.ts**:\n- handleDeviceListMessage(): Removed redundant \"initialState\" broadcast\n- setupEventHandlers(): Removed \"initialState\" from open/close/error events  \n- initialize(): Removed \"initialState\" from error handling\n\n### Technical Rationale\nThe popup's MessageHandler already correctly handles incremental updates:\n- \"deviceList\" messages update appState.connecteddevices\n- \"wsStatus\" messages update appState.wsConnected  \n- \"wsError\" messages update error states\n\nOnly **true initial state** (when popup first connects) should trigger \"initialState\" message via StateManager.addPopupPort().\n\n### Testing Verification\n- ✅ TypeScript compilation successful\n- ✅ No build errors\n- ✅ Preserves existing granular update system\n- ✅ UI state should now persist during device connections\n\n### Impact\n- **Fixed**: UI state no longer disappears when devices connect/disconnect\n- **Preserved**: All existing functionality and state synchronization\n- **Improved**: Cleaner state management with proper separation of concerns\n- **Eliminated**: Race conditions between state initialization and incremental updates\n\nThis fix maintains the sophisticated state management system while eliminating the problematic full-state resets that were causing UI state loss.",
  "category": "debugging",
  "dateCreated": "2025-06-16T08:53:17.970Z",
  "dateUpdated": "2025-06-16T08:53:17.970Z"
}