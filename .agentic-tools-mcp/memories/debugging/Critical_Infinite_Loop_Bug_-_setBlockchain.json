{
  "id": "8fed3247-9101-409a-bfbc-94383e055548",
  "title": "Critical Infinite Loop Bug - setBlockchain",
  "details": "## Critical Bug: Infinite Loop in Blockchain Selection - FIXED ✅\n\n### Issue Description\nThe MPC wallet was experiencing an infinite loop caused by a reactive statement in App.svelte that triggered blockchain updates continuously.\n\n### Root Cause Analysis\nIn `/src/entrypoints/popup/App.svelte` lines 312-332:\n```svelte\n$: if (appState.chain && port) {\n  // ...sends setBlockchain message\n  chrome.runtime.sendMessage({\n    type: \"setBlockchain\", \n    blockchain: blockchain,\n  }, (response) => {\n    // This callback updates appState.curve which triggers the reactive statement again!\n    appState.curve = blockchain === \"ethereum\" ? \"secp256k1\" : \"ed25519\";\n  });\n}\n```\n\n### The Loop Sequence\n1. Reactive statement triggers on appState.chain change\n2. Sends setBlockchain message to background\n3. Response callback updates appState.curve \n4. appState update triggers the reactive statement again\n5. Infinite loop continues\n\n### Solution Implemented ✅\n1. **Added Guard Variable**: `lastSentBlockchain` to track the last blockchain sent\n2. **Guard Condition**: Only trigger when `appState.chain !== lastSentBlockchain`\n3. **Removed State Update**: Removed `appState.curve` update from response callback\n4. **Error Recovery**: Reset guard on error to allow retry\n\n### Technical Fix\n```svelte\nlet lastSentBlockchain = '';\n$: if (appState.chain && port && appState.chain !== lastSentBlockchain) {\n  lastSentBlockchain = blockchain; // Set guard before sending\n  chrome.runtime.sendMessage(/* ... */);\n  // Removed: appState.curve update that caused the loop\n}\n```\n\n### Impact\n- ✅ Infinite loop eliminated\n- ✅ Reduced console spam\n- ✅ Background script no longer overwhelmed\n- ✅ Responsive user interface restored\n\n### Status: RESOLVED\nThe fix prevents the reactive statement from re-triggering on its own updates while maintaining proper blockchain selection functionality.",
  "category": "debugging",
  "dateCreated": "2025-06-13T12:00:52.174Z",
  "dateUpdated": "2025-06-13T12:01:18.782Z"
}